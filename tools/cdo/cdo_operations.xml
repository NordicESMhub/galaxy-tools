<tool id="cdo_operations" name="CDO Climate Data Manipulation Operators" profile="20.05" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>operations for standard processing of climate and NWP model output.</description>
    <macros>
        <import>macros.xml</import>
        <import>macros_operations.xml</import>
    </macros>
    <expand macro="edam_ontology"/>
    <requirements>
        <requirement type="package" version="3">python</requirement>
        <requirement type="package" version="@TOOL_VERSION@">cdo</requirement>
    </requirements>
    <stdio>
        <!-- Anything other than zero is an error -->
        <exit_code range="1:" />
        <exit_code range=":-1"/>
        <!-- In case the return code has not been set propery check stderr too -->
        <regex match="Error" />
        <regex match="Exception" />
        <regex match="Abort" />
    </stdio>
    <command detect_errors="exit_code"><![CDATA[
        mkdir output_dir &&
        cdo 
        #if $operator.opt == 'duplicate'
            '$operator.opt',$operator.ndup
        #elif $operator.opt == 'collgrid'
            #if str($operator.nx)
                #if str($operator.names)
                    '$operator.opt',$operator.nx,'$operator.names'
                #else
                    '$operator.opt',$operator.nx
                #end if
            #else
                '$operator.opt'
            #end if
        #elif $operator.opt == 'distgrid'
            '$operator.opt',$operator.nx,$operator.ny
        #elif $operator.opt == 'splitsel'
                #if str($operator.noffset)
                    #if str($operator.nskip)
                        '$operator.opt',$operator.nsets,$operator.noffset,$operator.nskip
                    #else
                        '$operator.opt',$operator.nsets,$operator.noffset
                    #end if
                #else
                    '$operator.opt',$operator.nsets

                #end if
        #elif $operator.opt == 'select' or $operator.opt == 'delete'
            '$operator.opt','$operator.params'
        #else
            '$operator.opt'
        #end if
        #for $i, $ifile in enumerate($operator.input_files):
            '${ifile.add_file}'
        #end for
        #if $operator.opt == 'splitcode' or $operator.opt == 'splitparam' or $operator.opt == 'splitname' or $operator.opt == 'splitlevel' or $operator.opt == 'splitgrid' or  $operator.opt == 'splitzaxis' or $operator.opt == 'splittabnum' or $operator.opt == 'splithour' or $operator.opt == 'splitday' or $operator.opt == 'splitseas' or $operator.opt == 'splityear' or $operator.opt == 'splityearmon' or $operator.opt == 'splitmon' 
            'output_dir/outfile_'
        #else
            'output_dir/outfile.netcdf'
        #end if
    ]]></command>
    <inputs>
        <expand macro="cdo_operator"/>
        <repeat name="section_operators" title="CDO Operators" >
            <expand macro="cdo_operator"/>
        </repeat>
        <repeat name="section_option" title="CDO Options" >
            <expand macro="cdo_option"/>
	</repeat>
    </inputs>
    <outputs>
        <collection name="output_files" type="list" label="${tool.name} outfiles">
            <discover_datasets pattern="__name__" directory="output_dir" visible="true" format="netcdf"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <conditional name="operator">
                <param name="opt" value="copy" />
                <repeat name="input_files">
                    <param name="add_file" value="WMI_Lear.nc" ftype="netcdf" />
                </repeat>
            </conditional>
            <output_collection name="output_files" type="list">
                <element name="outfile.netcdf" ftype="netcdf" file="WMI_Lear_copy.nc" compare="sim_size" delta="15"/>
            </output_collection>
        </test>
        <test>
            <conditional name="operator">
                <param name="opt" value="cat" />
                <repeat name="input_files">
                    <param name="add_file" value="drops1.nc" ftype="netcdf" />
                    <param name="add_file" value="drops2.nc" ftype="netcdf" />
                </repeat>
            </conditional>
            <output_collection name="output_files" type="list">
                <element name="outfile.netcdf" ftype="netcdf" file="drops_cat.nc" compare="sim_size" delta="15"/>
            </output_collection>
        </test>
        <test>
            <conditional name="operator">
                <param name="opt" value="splitname" />
                <repeat name="input_files">
                    <param name="add_file" value="lat_long.nc" ftype="netcdf" />
                </repeat>
            </conditional>
            <output_collection name="output_files" type="list" count="2"/>
        </test>
        <test>
            <conditional name="operator">
                <param name="opt" value="replace" />
                <repeat name="input_files">
                    <param name="add_file" value="lat_long.nc" ftype="netcdf" />
                    <param name="add_file" value="latitude_modified.nc" ftype="netcdf" />
                </repeat>
            </conditional>
            <output_collection name="output_files" type="list">
                <element name="outfile.netcdf" ftype="netcdf" file="lat_long_modified.nc" compare="sim_size" delta="20"/>
            </output_collection>
        </test>
        <test>
            <conditional name="operator">
                <param name="opt" value="duplicate" />
                <param name="ndup" value="3" ftype="integer" />
                <repeat name="input_files">
                    <param name="add_file" value="latitude.nc" ftype="netcdf" />
                </repeat>
            </conditional>
            <output_collection name="output_files" type="list">
                <element name="outfile.netcdf" ftype="netcdf" file="latitude3.nc" compare="sim_size" delta="15"/>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[

**Climate Data Operators (CDO)**
=======================================================================================================

This tool is a wrapper to the Climate Data Operators (CDO) for all operators manipulating input files and creating a new output file.

- CDO is a collection of command line Operators to manipulate and analyse Climate and NWP model Data.
- There are more than 600 operators available.

- `CDO online documentation <https://code.mpimet.mpg.de/projects/cdo/>`_.

    ]]></help>
    <expand macro="citations"/>
</tool>
